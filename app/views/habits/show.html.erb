<div class="row">
  <!-- 左側：習慣の詳細 -->
  <div class="col-md-6">
    <div class="habit-details">
      <div class="d-flex align-items-center mb-3">
      <!-- チェックボックス（作成者のみチェック可能） -->
        <% progress = @habit.progress_for_today(@habit.user) %>
        <%= check_box_tag "habit_#{@habit.id}_progress", progress.id, progress.checked, 
              data: { habit_id: @habit.id, controller: "habit-checkbox", action: "change->habit-checkbox#toggleCheckbox" }, 
              class: 'habit-checkbox me-2', 
              disabled: current_user != @habit.user %>

        <!-- 習慣名 -->
        <h1 class="mb-0"><%= @habit.habit_name %></h1>
      </div>
      <p><strong>説明:</strong> <%= @habit.description %></p>
      <p><strong>通知:</strong> <%= @habit.notification_time.strftime('%A %H:%M') if @habit.notification_time %></p>
      <p><strong>開始日〜終了日:</strong> <%= @habit.start_date %> 〜 <%= @habit.end_date %></p>
      <p><strong>作成日:</strong> <%= @habit.created_at.strftime('%Y-%m-%d %H:%M') %></p>
      <p><strong>作成者:</strong> <%= @habit.user.username.presence || '匿名ユーザー' %></p>
    </div>

    <% if current_user == @habit.user %>
      <div class="actions mt-3">
        <%= link_to '編集', edit_habit_path(@habit), class: 'btn btn-primary' %>
        <%= link_to '削除', habit_path(@habit), data: { turbo_method: :delete, turbo_confirm: '本当に削除しますか？' }, class: 'btn btn-danger' %>
      </div>
    <% end %>

    <%= link_to '戻る', habits_path, class: 'btn btn-secondary mt-3' %>
  </div>

  <!-- 右側：コメント一覧とコメント投稿フォーム -->
  <div class="col-md-6">
    <h2>コメント</h2>
    <div id="comments-section" class="mb-4">
      <% if @habit.comments.any? %>
        <% @habit.comments.each do |comment| %>
          <div class="comment mb-3 d-flex align-items-center">
            <p class="me-3"><strong><%= comment.user.username.presence || '匿名ユーザー' %></strong></p>
            <p class="flex-grow-1"><%= comment.content %></p>
            <p class="text-muted ms-3"><%= comment.created_at.strftime('%Y-%m-%d %H:%M') %></p>
            <% if current_user == comment.user %>
              <div class="ms-3">
                <%= link_to '編集', edit_habit_comment_path(@habit, comment), class: 'btn btn-sm btn-outline-primary' %>
                <%= link_to '削除', habit_comment_path(@habit, comment), data: { turbo_method: :delete, turbo_confirm: '本当に削除しますか？' }, class: 'btn btn-sm btn-outline-danger' %>
              </div>
            <% end %>
          </div>
          <hr>
        <% end %>
      <% else %>
        <p>コメントはまだありません。</p>
      <% end %>
    </div>

    <!-- コメント投稿フォーム -->
    <h2>コメントを投稿</h2>
    <%= form_with model: [@habit, Comment.new], local: true do |form| %>
      <div class="form-group">
        <%= form.text_area :content, class: 'form-control', placeholder: 'コメントを入力してください' %>
      </div>
      <div class="form-group mt-2">
        <%= form.submit '投稿', class: 'btn btn-success' %>
      </div>
    <% end %>
  </div>
</div>
